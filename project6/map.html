<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- KNOCKOUT.JS -->
    <script src = "https://ajax.aspnetcdn.com/ajax/knockout/knockout-3.1.0.js"
      type = "text/javascript"></script>
    <!-- W3.CSS FRAMEWORK -->
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <!-- BOOTSTRAP -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <title>Neighborhood Map</title>
    <style type="text/css">
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
        z-index: 1;
      }

      #navigation {
        z-index: 2;
        width: 300px;
        color: white;
        background-color: rgb(71, 73, 76);
      }

      #navButton {
        z-index: 2;
        width: auto;
      }

    </style>
  </head>
  <body>
    <div class="w3-sidebar w3-bar-block w3-collapse w3-card w3-animate-left" id="navigation">
      <button class="w3-bar-item w3-button w3-large w3-hide-large" onclick="w3_close()">Close &times;</button>
      <div id="navigation-title"> Carrollton, Texas</div>
      <label for="search-box">Search</label>
      <span class="glyphicon glyphicon-search"></span>
      <input id="search-box" class="form-control" type="text" placeholder="Enter location name">
      <br>
      <label for="filters">Filter</label>
      <select id="filters">
        <option value="cafe">Caf√©s</option>
        <option value="shops">Shops</option>
        <option value="service">Services</option>
        <option value="restaurant">Restaurant</option>
      </select>

    </div>
    <button type="button" class="w3-button w3-xlarge w3-hide-large" id="navButton" onclick="w3_open()">&#9776;</button>
    <div id="map"></div>

    <script type="text/javascript">
      var map;
      /* LOAD MAP */
      function initMap() {
        try {
          /* CREATE MAP */
          map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 32.981539, lng: -96.908635},
            zoom: 15
          });
          /* CREATE WINDOW TO SHOW INFO WHEN CLICK ON MARKER*/
          var infoWindow = new google.maps.InfoWindow();
          /* ARRAY TO HOLD ALL THE MARKS */
          var landmarks = []
          /* ARRAY OF LOCATION ATTRIBUTES AS OBJECTS */
          var landmark_info = [
            {title: "Daiso Japan", position: {lat: 32.981539, lng: -96.908635}},
            {title: "H Mart", position: {lat: 32.985835, lng: -96.910009}},
            {title: "Caffebene", position: {lat: 32.983966, lng: -96.911424}},
            {title: "Chick-fil-A", position: {lat: 32.986195, lng: -96.909300}},
            {title: "Java Gaming Cafe", position: {lat: 32.988245, lng: -96.910358}},
            {title: "Walmart", position: {lat: 32.985984, lng: -96.905989}}
          ]
          /* LOAD LOCATION MARKERS AND STORE IN MARKER ARRAY */
          for (i=0; i<landmark_info.length; i++) {
            var marker = new google.maps.Marker({
              position: landmark_info[i].position,
              title: landmark_info[i].title,
              animation: google.maps.Animation.DROP,
              map: map
            });
            /*ADD LISTENER. OPENS MODAL TO SHOW MORE INFO*/
            marker.addListener("click", function() {
              show_location_info(this, infoWindow);
            });
            landmarks.push(marker);
          }

          /* ALLOW MAP TO RESIZE AUTOMATICALLY WHEN SCREEN RESIZES */
          google.maps.event.addDomListener(window, "resize", function() {
            var center = map.getCenter();
            google.maps.event.trigger(map, "resize");
            map.setCenter(center);
          });

          /* ACTIVATE KNOCKOUT.JS VIEW MODEL */
          ko.applyBindings(new MapViewModel());

        }
        catch(error) {
          alert("Google maps failed to load.");
        }

      } // END OF MAP INITMAP() FUNCTION

      /* AJAX TO 3rd PARTY API TO GET MORE INFO. LOAD LOCATION INFO TO MODAL */
      function show_location_info(marker, w) {
        w.marker = marker;
        /* USE FOURSQUARE TO GET MORE INFO ON LOCATION */
        var CLIENT_ID = "1NUJUS2D1N5AKDEUR5A3VFFKTM5YJDOG50LIK42AJSAM13O2";
        var CLIENT_SECRET = "3DYAJ5IICN42ZAD5Z4YXGF1N3GD0DN3WNLIGKBTW01IRKRIF";
        var FOURSQUARE_URL = "https://api.foursquare.com/v2/venues/search";
        var DATA_PARAMS = {
          query: marker.title,
          near: "Carrollton, Texas",
          client_id: CLIENT_ID,
          client_secret: CLIENT_SECRET,
          v: "20180304",
          limit: 1
        };

        $.ajax({
          url: FOURSQUARE_URL,
          data: DATA_PARAMS,
          dataType: "json",
          success: function(data) {
            /* ADD IN EXTRA INFO FROM FOURSQUARE. IF-ELSE THERE IN CASE
            SOME ATTRIBUTES ARE NOT RETURNED FROM JSON OBJECT */
            var category = "<strong>Category: </strong>: N/A <br>";
            var phone = "<strong>Phone: </strong>: N/A <br>";
            var twitter = "<strong>Twitter Handle: </strong>: N/A <br>";
            var facebook = "<strong>Facebook ID: </strong>: N/A <br>";
            var url = "<strong>Website: </strong>: N/A <br>";
            var menu = "<strong>Menu: </strong>: N/A <br>";
            var user_checkin = "<strong>Checkin Count: </strong>: N/A <br>";
            /* GET CATEGORY*/
            console.log(data['response']['venues'][0]['categories'] != undefined);
            if (data['response']['venues'][0]['categories'] != undefined) {
              cat = data['response']['venues'][0]['categories'][0]['name'];
              category = "<strong>Category: </strong>" + cat + "<br>";
            }
            /* GET CONTACT INFO */
            if (data['response']['venues'][0]['contact'] != undefined) {
               if (data['response']['venues'][0]['contact']['formattedPhone'] != undefined) {
                 var phone_num = data['response']['venues'][0]['contact']['formattedPhone'];
                 phone = "<strong>Phone: </strong>" + phone_num + "<br>";
               }
               if (data['response']['venues'][0]['contact']['twitter'] != undefined) {
                 var twitter_id = data['response']['venues'][0]['contact']['twitter'];
                 phone = "<strong>Twitter Handle: </strong>@" + twitter_id + "<br>"
               }
               if (data['response']['venues'][0]['contact']['facebookUsername'] != undefined) {
                 var fb_name = data['response']['venues'][0]['contact']['facebookUsername'];
                 facebook = "<strong>Facebook ID: </strong>" + fb_name + "<br>"
               }
            }
            /* GET WEBSITE LINK */
            if (data['response']['venues'][0]['url'] != undefined) {
              the_url = data['response']['venues'][0]['url'];
              url = "<strong>Website: </strong><a href='" + the_url + "'>Website</a><br>";
            }
            /* GET MENU LINK */
            if (data['response']['venues'][0]['menu'] != undefined) {
              m = data['response']['venues'][0]['menu']['url']
              menu = "<strong>Menu: </strong><a href='" + m + "'>Menu</a><br>";
            }
            /* GET USER CHECKIN NUMBER*/
            if (data['response']['venues'][0]['stats']['checkinsCount'] != undefined) {
              num = data['response']['venues'][0]['stats']['checkinsCount'];
              user_checkin = "<strong>Checkin Count: </strong>" + num + "<br>";
            }
            var content = "<strong>Location: </strong>" + marker.title + "<br>"
                          + category + phone + twitter + facebook
                          + url + menu + user_checkin;
            w.setContent(content);
            marker.setAnimation(google.maps.Animation.BOUNCE);
            setTimeout(function() {
    			       marker.setAnimation(null);
    		    }, 2000);
            w.open(map, marker);
          },
          error: function(xhr) {
            alert("Error in loading data from FourSquare");
          },
          fail: function() {
            alert("FourSquare failed to load.");
          }
        });



      }
      function w3_open() {
        document.getElementById("navigation").style.display = "block";
      }
      function w3_close() {
        document.getElementById("navigation").style.display = "none";
      }

      /* KNOCKOUT VIEW MODEL */
      var MapViewModel = function() {

      }

    </script>
    <!--GOOGLE MAPS API KEY-->
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?v=3&key=AIzaSyC1K1093KIoWuDlnhvx4KFLPzfiDfX-pRo&callback=initMap">
    </script>
  </body>
</html>
